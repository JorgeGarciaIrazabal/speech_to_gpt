"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[510],{510:(k,p,i)=>{i.r(p),i.d(p,{ChatPage:()=>B});var f=i(467),c=i(177),h=i(4341),t=i(3954),u=i(9323),E=i(1577),C=i(5873),P=i(174),e=i(4438),O=i(369),D=i(403);const y=["input"],T=(a,r)=>({"message-user":a,"message-assistant":r});function R(a,r){if(1&a&&(e.j41(0,"ion-item",13)(1,"ion-label"),e.nrm(2,"markdown",14),e.k0s()()),2&a){const l=r.$implicit;e.Y8G("ngClass",e.l_i(2,T,"user"===l.role,"assistant"===l.role)),e.R7$(2),e.Y8G("data",l.content)}}function v(a,r){if(1&a&&(e.j41(0,"ion-label"),e.nrm(1,"ion-spinner"),e.EFF(2),e.k0s()),2&a){const l=e.XpG();e.R7$(2),e.JRh(l.logMessage)}}function I(a,r){1&a&&e.nrm(0,"ion-spinner")}function U(a,r){1&a&&e.nrm(0,"ion-icon",15)}let B=(()=>{var a;class r{constructor(n,s){this.storage=n,this.router=s,this.messages=[],this.newMessage="",this.sendingMessage=!1,this.logMessage="",this._storage=null,(0,E.a)({send:C.tN8})}ngOnInit(){var n=this;return(0,f.A)(function*(){console.log("init ChatPage"),n._storage=yield n.storage.create();try{var s;const o=yield null===(s=n._storage)||void 0===s?void 0:s.get("token");u.Ds.TOKEN=o.access_token,yield u.Zc.readUsersMeUsersMeGet()}catch{console.error("User is not authenticated"),n.router.navigate(["/login/logout"])}console.log("User is authenticated"),setTimeout(()=>{n.inputElement.setFocus()},1)})()}sendMessage(){var n=this;return(0,f.A)(function*(){yield n.storage.create(),n.messages.push({content:n.newMessage,role:"user"}),n.sendingMessage=!0;let s="";try{const o=yield fetch(u.Ds.BASE+"/chat",{method:"POST",body:JSON.stringify(n.messages),headers:{"Content-Type":"application/json",Authorization:`Bearer ${u.Ds.TOKEN}`}});if(!o.ok&&401===o.status)return void(yield n.router.navigate(["/login/logout"]));const g={content:"",role:"assistant"};if(n.messages.push(g),null==o.body)throw new Error("Response body is null");const _=o.body.getReader();for(;;){const{done:b,value:j}=yield _.read();if(b)break;s+=new TextDecoder("utf-8").decode(j);const d=s.split("%%%%");for(let m=0;m<d.length-1;m++){const M=JSON.parse(d[m]);"log_message"!==M.role?g.content+=M.content:n.logMessage=M.content}s=d[d.length-1]}}catch(o){n.messages.pop(),console.error(o)}finally{n.sendingMessage=!1,n.newMessage="",yield n.inputElement.setFocus(),n.logMessage=""}})()}clearChat(){this.messages=[]}}return(a=r).\u0275fac=function(n){return new(n||a)(e.rXU(O.w),e.rXU(D.Ix))},a.\u0275cmp=e.VBU({type:a,selectors:[["app-chat"]],viewQuery:function(n,s){if(1&n&&e.GBs(y,5),2&n){let o;e.mGM(o=e.lsd())&&(s.inputElement=o.first)}},standalone:!0,features:[e.aNF],decls:27,vars:8,consts:[["input",""],[3,"translucent"],["slot","start"],[3,"fullscreen"],["collapse","condense"],["size","large"],["id","container"],["class","message",3,"ngClass",4,"ngFor","ngForOf"],[4,"ngIf"],["placeholder","Enter your message",3,"ngModelChange","keyup.enter","ngModel"],["size","auto"],[3,"click","disabled"],["name","send",4,"ngIf"],[1,"message",3,"ngClass"],[3,"data"],["name","send"]],template:function(n,s){if(1&n){const o=e.RV6();e.j41(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-buttons",2),e.nrm(3,"ion-menu-button"),e.k0s(),e.j41(4,"ion-title"),e.EFF(5,"Chat"),e.k0s()()(),e.j41(6,"ion-content",3)(7,"ion-header",4)(8,"ion-toolbar")(9,"ion-title",5),e.EFF(10,"chat"),e.k0s()()(),e.j41(11,"div",6)(12,"ion-list"),e.DNE(13,R,3,5,"ion-item",7),e.k0s()()(),e.j41(14,"ion-footer")(15,"ion-toolbar")(16,"ion-grid")(17,"ion-row"),e.DNE(18,v,3,1,"ion-label",8),e.k0s(),e.j41(19,"ion-row")(20,"ion-col")(21,"ion-input",9,0),e.mxI("ngModelChange",function(_){return e.eBV(o),e.DH7(s.newMessage,_)||(s.newMessage=_),e.Njj(_)}),e.bIt("keyup.enter",function(){return e.eBV(o),e.Njj(s.sendMessage())}),e.k0s()(),e.j41(23,"ion-col",10)(24,"ion-button",11),e.bIt("click",function(){return e.eBV(o),e.Njj(s.sendMessage())}),e.DNE(25,I,1,0,"ion-spinner",8)(26,U,1,0,"ion-icon",12),e.k0s()()()()()()}2&n&&(e.Y8G("translucent",!0),e.R7$(6),e.Y8G("fullscreen",!0),e.R7$(7),e.Y8G("ngForOf",s.messages),e.R7$(5),e.Y8G("ngIf",s.logMessage),e.R7$(3),e.R50("ngModel",s.newMessage),e.R7$(3),e.Y8G("disabled",""===s.newMessage),e.R7$(),e.Y8G("ngIf",s.sendingMessage),e.R7$(),e.Y8G("ngIf",!s.sendingMessage))},dependencies:[t.W9,t.eU,t.BC,t.ai,c.MD,c.YU,c.Sq,c.bT,h.YN,h.BC,h.vS,t.QW,t.MC,t.Jm,t.nf,t.uz,t.he,t.M0,t.$w,t.w2,t.iq,t.ln,t.lO,t.hU,P.NN],styles:[".message[_ngcontent-%COMP%]{color:#000;border-radius:15px;padding:3px;margin:3px;box-shadow:0 0 10px #0000001a;--border-radius: 6px}.message-user[_ngcontent-%COMP%]{text-align:right;--background: #d1ecf1}.message-assistant[_ngcontent-%COMP%]{text-align:left;--background: #f8d7da}"]}),r})()}}]);